# 🛰️ PulseChat 技术原理：消息是如何“飞”到对方手机上的？

如果你把传统的聊天软件（如微信）比作**“必须要经过邮局转交的信件”**，那么 PulseChat 更像是**“两个人面对面用密语交谈”**。

下面我们将消息从“你点击发送”到“对方看到”的全过程拆解为四个步骤：

---

### 第一步：消息“变身”——端到端加密 (End-to-End Encryption)
在你点击发送的一瞬间，消息并不是以文字形式发出的，而是立即被“锁”住了。

*   **用到的技术**：**XOR 动态加密算法**。
*   **小白理解**：你和对方在设置里约定了一个“暗号”（比如 `123456`）。当你输入“你好”时，手机会根据这个暗号，把“你好”转换成一串完全看不懂的乱码（比如 `x&2%#@`）。
*   **为什么安全**：只有拥有相同暗号的手机才能把乱码转回文字。即使消息在传输过程中被黑客截获，或者服务器管理员偷看，他们看到的也只是乱码。

---

### 第二步：路径选择——混合信令与 P2P (P2P Discovery)
手机需要找到对方在哪里。PulseChat 会根据你们的网络环境，自动选择最快的路径。

1.  **局域网搜索 (Zeroconf / mDNS)**：
    *   **场景**：你们都在同一个家里的 WiFi 下。
    *   **原理**：你的手机会在 WiFi 里大喊一声：“我是 A，谁是 B？”对方手机听到后会回应：“我是 B，我的地址是 192.168.1.5”。
    *   **优势**：不经过互联网，速度极快，且完全私密。

2.  **互联网辅助 (Socket.IO 中继)**：
    *   **场景**：你在公司用 5G，他在家用 WiFi。
    *   **原理**：你们都会连接到一个公共的“公告板”（我们的互联网服务器）。服务器只负责告诉你们：“A 在线，B 也在线”，就像一个指路牌。

---

### 第三步：建立“专属隧道”——WebRTC 与 TCP 降级
一旦找到了对方，两台手机就会尝试打通一条只有它们两个人的“专属隧道”。

1.  **WebRTC (高级隧道)**：
    *   这是最理想的状态。两台手机直接建立连接，数据像在水管里一样直接流动，不经过任何中间服务器。
2.  **TCP 降级 (备用隧道)**：
    *   如果手机防火墙太严，WebRTC 隧道打不通，系统会自动切换到“消息转发机制”。通过我们之前说的“指路牌服务器”把加密后的乱码消息传过去。

---

### 第四步：消息投递与解密
对方手机收到数据后，会经过最后几道工序：

1.  **Redux 状态管理**：手机内存立即把这条消息放进对应的聊天列表中。
2.  **MMKV 持久化存储**：消息被瞬间存入手机的本地数据库（MMKV 是目前手机端读写最快的存储技术），确保即便关机重启消息也不会丢。
3.  **反向解密**：对方手机使用你们约定的“暗号”，把那串乱码（`x&2%#@`）变回原来的“你好”。

---

### 🌟 核心总结：为什么 PulseChat 与众不同？

| 环节 | 我们用的技术 | 为什么选它？ |
| :--- | :--- | :--- |
| **消息安全** | XOR 加密 & 阅后即焚 | 只有聊天双方能解密，中间人看全是乱码。 |
| **找人方式** | Zeroconf (局域网) + Socket.IO (互联网) | 无论是在同一个 WiFi 还是跨城市 5G，都能秒连。 |
| **传输通道** | WebRTC + TCP 降级 | 优先追求“点对点”直连，不经过第三方，保护隐私。 |
| **存储性能** | MMKV 高性能存储 | 像微信一样快，打开聊天记录完全不卡顿。 |

**简单一句话说：** 
PulseChat 先把你的话变成**只有你俩懂的暗号**，然后像**雷达探路**一样找到对方，最后通过一条**私人管道**把暗号传过去。整个过程，除了你们两台手机，没有任何地方存有你们的聊天原件。
